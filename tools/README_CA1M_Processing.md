# CA-1M数据集多线程处理工具

这个工具专门用于处理CA-1M数据集，支持多线程并行处理，生成NOCS图像和归一化实例点云。

## 功能特性

- 🚀 **多线程处理**: 支持多个场景并行处理和单场景内多线程操作
- 🖼️ **NOCS图生成**: 多线程生成归一化物体坐标空间图像
- 🎯 **实例点云**: 按instance ID组织的归一化点云数据
- 📦 **体素下采样**: 使用Open3D进行高效点云下采样
- 📊 **bbox信息保存**: 保存完整的3D边界框信息
- 🔄 **数据集划分支持**: 支持train/val数据集划分

## 输出结构

```
CA-1M_output/
├── train/                    # 训练集输出
│   ├── scene1/              # 场景文件夹
│   │   ├── nocs_images/     # NOCS图像
│   │   │   ├── frame_0001_nocs.png
│   │   │   └── ...
│   │   ├── objects/         # 归一化实例点云
│   │   │   ├── instance_1.ply
│   │   │   ├── instance_2.ply
│   │   │   └── ...
│   │   └── scene_bbox_info.json  # 场景bbox信息
│   └── ...
└── val/                     # 验证集输出
    └── ...
```

## 使用方法

### 基本用法

```bash
# 处理训练集
python tools/demo_multithread_ca1m.py --split train

# 处理验证集
python tools/demo_multithread_ca1m.py --split val
```

### 使用便捷脚本

```bash
# 给脚本添加执行权限
chmod +x tools/run_ca1m_processing.sh

# 处理训练集
./tools/run_ca1m_processing.sh train

# 处理验证集
./tools/run_ca1m_processing.sh val

# 测试模式（仅处理前10个场景）
./tools/run_ca1m_processing.sh train --max-scenes 10
```

## 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--data-dir` | `/baai-cwm-vepfs/cwm/chongjie.ye/data/CA-1M/data` | CA-1M数据集根目录 |
| `--output-dir` | `/baai-cwm-vepfs/cwm/chongjie.ye/data/CA-1M_output` | 输出目录 |
| `--split` | 必需 | 数据集划分 (train/val) |
| `--voxel-size` | 0.004 | 体素下采样尺寸 |
| `--disable-downsampling` | False | 禁用体素下采样 |
| `--max-workers` | 4 | 单场景内最大线程数 |
| `--scene-workers` | 2 | 场景处理线程数 |
| `--max-scenes` | None | 最大处理场景数（测试用） |

## 性能优化

### 线程数配置建议

- **场景处理线程数** (`--scene-workers`): 建议设置为CPU核心数的1/4到1/2
- **单场景线程数** (`--max-workers`): 建议设置为4-8，取决于内存大小

### 内存使用

- 每个场景大约需要2-4GB内存
- 建议总内存 ≥ 8GB × scene_workers

### 存储空间

- 每个场景约需要100-500MB存储空间
- CA-1M完整数据集处理后约需要100-200GB空间

## 输出文件说明

### NOCS图像
- **格式**: PNG图像
- **内容**: 归一化物体坐标空间的可视化
- **命名**: `frame_XXXX_nocs.png`

### 实例点云
- **格式**: PLY点云文件
- **内容**: 归一化后的实例点云（包含颜色）
- **命名**: `instance_X.ply`

### bbox信息
- **格式**: JSON文件
- **内容**: 每个实例的3D边界框信息
- **包含**: 中心点、旋转矩阵、尺寸、角点坐标

## 错误处理

工具会自动处理以下情况：
- 缺失的深度数据
- 无效的实例数据
- 文件读写错误
- 内存不足

失败的场景会在最终报告中列出，成功处理的场景不受影响。

## 监控处理进度

工具会实时输出处理进度：
- 场景级别的处理状态
- 帧级别的处理统计
- 详细的耗时分析
- 成功/失败统计

## 示例输出

```
================================================================================
🚀 CA-1M数据集多线程处理工具
================================================================================
📁 数据目录: /baai-cwm-vepfs/cwm/chongjie.ye/data/CA-1M/data
📤 输出目录: /baai-cwm-vepfs/cwm/chongjie.ye/data/CA-1M_output
📊 处理划分: train
🧵 最大线程数: 4
🎬 场景处理线程数: 2
📦 体素下采样尺寸: 0.004m
================================================================================

📁 在 train 集中发现 1000 个场景文件

🎬 开始多线程处理 1000 个场景...

🎬 开始处理场景: ca1m-scene001
📊 处理场景 ca1m-scene001 第 10 帧...
🖼️ 开始多线程生成 150 个NOCS图像...
💾 开始多线程保存 25 个归一化实例点云...
✅ 场景 ca1m-scene001 处理完成！

...

================================================================================
📊 处理完成统计报告
================================================================================
🕒 总处理时间: 3600.00秒
✅ 成功处理场景: 995 个
❌ 失败场景: 5 个
📊 总处理帧数: 150000
🎯 总实例数: 25000
⚡ 平均每场景处理时间: 3.62秒
================================================================================
```
